<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>LC-MS/MS Data Annotation using R and Python • Metabonaut</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="SpectriPy-tutorial-metabonaut_files/libs/quarto-html/popper.min.js"></script><script src="SpectriPy-tutorial-metabonaut_files/libs/quarto-html/tippy.umd.min.js"></script><link href="SpectriPy-tutorial-metabonaut_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="SpectriPy-tutorial-metabonaut_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="LC-MS/MS Data Annotation using R and Python">
<meta property="og:image" content="https://rformassspectrometry.github.io/Metabonaut/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Metabonaut</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/install_v0.html">Installation instructions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-workflows" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Workflows</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-workflows">
<li><a class="dropdown-item" href="../articles/a-end-to-end-untargeted-metabolomics.html">End-to-end workflow for untargeted metabolomics data analysis in R</a></li>
    <li><a class="dropdown-item" href="../articles/dataset-investigation.html">Dataset investigation: What to do when you get your data</a></li>
    <li><a class="dropdown-item" href="../articles/alignment-to-external-dataset.html">Seamless Alignment: Merging New data with Existing Preprocessed Datasets</a></li>
    <li><a class="dropdown-item" href="../articles/SpectriPy-tutorial-metabonaut.html">LC-MS/MS Data Annotation using R and Python</a></li>
    <li><a class="dropdown-item" href="../articles/large-scale-analysis.html">Large Scale Data Preprocessing with xcms</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rformassspectrometry/Metabonaut/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>LC-MS/MS Data Annotation using R and Python</h1>

      <p class="author">Marilyn De Graeve, Johannes Rainer</p>
      <p class="date">2025-07-16</p>

      <small class="dont-index">Source: <a href="https://github.com/rformassspectrometry/Metabonaut/blob/devel/vignettes/SpectriPy-tutorial-metabonaut.qmd" class="external-link"><code>vignettes/SpectriPy-tutorial-metabonaut.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <section class="section level2"><h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <em>SpectriPy</em> R package enables powerful mass spectrometry (MS) data analysis workflows combining the strengths of Python and R MS libraries <span class="citation" data-cites="graeve_spectripy_2025">(<a href="#ref-graeve_spectripy_2025" role="doc-biblioref">Graeve et al. 2025</a>)</span>. General concepts and examples of the package are available in the package’s <a href="https://rformassspectrometry.github.io/SpectriPy/articles/SpectriPy.html" class="external-link"><em>main</em> vignette</a>.</p>
<p>As an example for a combined R/Python workflow, we annotate the LC-MS/MS spectra from the main end-to-end vignette using Python’s <em>matchms</em> library.</p>
<p>The MS2 processing methods which will be demonstrated on the used spectral reference library consists of the default filtering functionality from <em>matchms</em> <span class="citation" data-cites="huber_matchms_2020">(<a href="#ref-huber_matchms_2020" role="doc-biblioref">Huber et al. 2020</a>)</span> (<code>default_filters()</code>, <code>add_parent_mass()</code> and <code><a href="https://rdrr.io/pkg/SpectriPy/man/filterSpectriPy.html" class="external-link">normalize_intensities()</a></code>).</p>
<p>The MS2 spectral similarity algorithm which is demonstrated here is the <code><a href="https://rdrr.io/pkg/SpectriPy/man/compareSpectriPy.html" class="external-link">ModifiedCosine()</a></code> from <em>matchms</em> <span class="citation" data-cites="huber_matchms_2020">(<a href="#ref-huber_matchms_2020" role="doc-biblioref">Huber et al. 2020</a>)</span>.</p>
<p>The spectral reference library used for the annotation of the unknown features in this tutorial originates from a small <em>in-house</em> reference library (provided in MGF format) available in the <em>SpectriPy</em> package.</p>
<p>The analysis in this document is performed using R and Python code chunks. A comment <em>#’ R session:</em> or <em>#’ Python session:</em> is used for easier distinction of these.</p>
</section><section class="section level2"><h2 id="load-spectripy">Load <em>SpectriPy</em>
<a class="anchor" aria-label="anchor" href="#load-spectripy"></a>
</h2>
<p>Load the required R <em>SpectriPy</em> package. If you already have a Python environment opened, please restart your Integrated Development Environment and run this as a first command, to load the required package <em>reticulate</em> and setup the conda environment ‘r-spectripy’ correctly. Please see the <a href="https://rformassspectrometry.github.io/SpectriPy/articles/detailed-installation-configuration.html" class="external-link">Detailed information on installation and configuration</a> document for other options.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' R session:</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/SpectriPy" class="external-link">SpectriPy</a></span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="section level2"><h2 id="load-query-ms2-data">Load query MS2 data<a class="anchor" aria-label="anchor" href="#load-query-ms2-data"></a>
</h2>
<p>The LC-MS/MS query data used in this tutorial, are derived from the Metabonaut resource <span class="citation" data-cites="louail_metabonaut_2025">(<a href="#ref-louail_metabonaut_2025" role="doc-biblioref">Louail and Rainer 2025</a>)</span>. Introduction and a thorough description of the preprocessing steps performed are described in <a href="https://rformassspectrometry.github.io/Metabonaut/articles/end-to-end-untargeted-metabolomics.html">A Complete End-to-End Workflow for untargeted LC-MS/MS Metabolomics Data Analysis in R</a>.</p>
<p>First, we load the <code>Spectra</code> object with the MS2 spectra of the unknown features found to be significant in the “Differential abundance analysis”, see section <a href="https://rformassspectrometry.github.io/Metabonaut/articles/end-to-end-untargeted-metabolomics.html#differential-abundance-analysis">MS2-based annotation</a>. This <code>Spectra</code> object is shared as part of the <em>Metabonaut</em> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' R session:</span></span>
<span></span>
<span><span class="co">#' R MS package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link">Spectra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Load the MS2 spectra of significant features</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"spectra_significant_fts.RData"</span>,</span>
<span>                 package <span class="op">=</span> <span class="st">"Metabonaut"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ms2_ctr_fts</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MSn data (Spectra) with 315 spectra in a MsBackendMemory backend:
      msLevel     rtime scanIndex
    &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
1           2   147.357      2043
2           2   148.587      2061
3           2   149.817      2079
4           2   152.297      2115
5           2   147.376      2041
...       ...       ...       ...
311         2   178.082      2481
312         2   179.322      2499
313         2   180.572      2517
314         2   181.822      2535
315         2   183.072      2553
 ... 39 more variables/columns.
Processing:
 Filter: select retention time [10..240] on MS level(s) 1 2 [Tue Mar 18 11:56:42 2025]
 Filter: select MS level(s) 2 [Tue Mar 18 11:56:50 2025]
 Remove peaks based on their intensities and a user-provided function in spectra of MS level(s) 2. [Tue Mar 18 11:56:50 2025]
 ...19 more processings. Use 'processingLog' to list all. </code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Print the available metadata, stored in the Spectra object</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">ms2_ctr_fts</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "msLevel"                    "rtime"
 [3] "acquisitionNum"             "scanIndex"
 [5] "dataStorage"                "dataOrigin"
 [7] "centroided"                 "smoothed"
 [9] "polarity"                   "precScanNum"
[11] "precursorMz"                "precursorIntensity"
[13] "precursorCharge"            "collisionEnergy"
[15] "isolationWindowLowerMz"     "isolationWindowTargetMz"
[17] "isolationWindowUpperMz"     "peaksCount"
[19] "totIonCurrent"              "basePeakMZ"
[21] "basePeakIntensity"          "ionisationEnergy"
[23] "lowMZ"                      "highMZ"
[25] "mergedScan"                 "mergedResultScanNum"
[27] "mergedResultStartScanNum"   "mergedResultEndScanNum"
[29] "injectionTime"              "filterString"
[31] "spectrumId"                 "ionMobilityDriftTime"
[33] "scanWindowLowerLimit"       "scanWindowUpperLimit"
[35] "electronBeamEnergy"         "mtbls_id"
[37] "mtbls_assay_name"           "derived_spectral_data_file"
[39] "collision_energy"           "feature_id"                </code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Print the feature_id of the first spectrum</span></span>
<span><span class="va">ms2_ctr_fts</span><span class="op">$</span><span class="va">feature_id</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "FT0371"</code></pre>
</div>
</div>
</section><section class="section level2"><h2 id="filter-query-data">Filter query data<a class="anchor" aria-label="anchor" href="#filter-query-data"></a>
</h2>
<p>To ensure this <code>Spectra</code> object only contains MS2 data, we filter to only MS2 spectra with more than 2 fragment peaks per spectrum using some classical filtering functions from the <em>Spectra</em> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' R session:</span></span>
<span></span>
<span><span class="co">#' Filter MS2 level data</span></span>
<span><span class="va">ms2_ctr_fts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterMsLevel</a></span><span class="op">(</span><span class="va">ms2_ctr_fts</span>, <span class="fl">2L</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' filter minimum 3 fragment peaks</span></span>
<span><span class="va">ms2_ctr_fts</span> <span class="op">&lt;-</span> <span class="va">ms2_ctr_fts</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">ms2_ctr_fts</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">]</span></span>
<span><span class="va">ms2_ctr_fts</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MSn data (Spectra) with 291 spectra in a MsBackendMemory backend:
      msLevel     rtime scanIndex
    &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
1           2   147.357      2043
2           2   148.587      2061
3           2   152.297      2115
4           2   147.376      2041
5           2   148.616      2059
...       ...       ...       ...
287         2   178.082      2481
288         2   179.322      2499
289         2   180.572      2517
290         2   181.822      2535
291         2   183.072      2553
 ... 39 more variables/columns.
Processing:
 Filter: select retention time [10..240] on MS level(s) 1 2 [Tue Mar 18 11:56:42 2025]
 Filter: select MS level(s) 2 [Tue Mar 18 11:56:50 2025]
 Remove peaks based on their intensities and a user-provided function in spectra of MS level(s) 2. [Tue Mar 18 11:56:50 2025]
 ...20 more processings. Use 'processingLog' to list all. </code></pre>
</div>
</div>
</section><section class="section level2"><h2 id="load-reference-ms2-data">Load reference MS2 data<a class="anchor" aria-label="anchor" href="#load-reference-ms2-data"></a>
</h2>
<p>As the <em>in-house</em> spectral library, we import a small test data file in MGF format. This file is part of the <em>SpectriPy</em> package and we below define its path on the local computer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' R session:</span></span>
<span></span>
<span><span class="co">#' Define a variable with the path and file name of the MGF file</span></span>
<span><span class="va">mgf_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"mgf"</span>, <span class="st">"test.mgf"</span>, package <span class="op">=</span> <span class="st">"SpectriPy"</span><span class="op">)</span></span></code></pre></div>
</div>
<p>The loading of this file is then performed using the Python <em>matchms</em> library. The variable with the MGF file name can be accessed in the associated Python session using <code>r.mgf_file</code>. The loaded object is a Python list of <code>matchms.Spectrum</code> objects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Python session:</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matchms.importing <span class="im">import</span> load_from_mgf</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' Read spectra from an MGF formatted file, as Spectrum object</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>mgf_py <span class="op">=</span> <span class="bu">list</span>(load_from_mgf(r.mgf_file))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' Nr of spectra</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(mgf_py)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code><span><span class="fl">100</span></span></code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Access the first spectrum</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>mgf_py[<span class="dv">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Spectrum(precursor m/z=259.06, 3 fragments between 213.1 and 259.1)</code></pre>
</div>
</div>
<p>Note that we can also access the first spectrum from an R session, by starting the command with <code>py$</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' R session:</span></span>
<span></span>
<span><span class="co">#' Access the first spectrum</span></span>
<span><span class="va">py</span><span class="op">$</span><span class="va">mgf_py</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Spectrum(precursor m/z=259.06, 3 fragments between 213.1 and 259.1)</code></pre>
</div>
</div>
</section><section class="section level2"><h2 id="translate-query-ms-data-to-python">Translate query MS data to Python<a class="anchor" aria-label="anchor" href="#translate-query-ms-data-to-python"></a>
</h2>
<p>First, we check if the R <code>Spectra</code> object containing the query MS2 data can be accessed in Python using the <code>r.</code> prefix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Python session:</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' check if the r Spectra object can be accessed in python using the 'r.'</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' prefix. Print the first spectrum</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>r.ms2_ctr_fts[<span class="dv">1</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Spectrum(precursor m/z=138.05, 4 fragments between 73.1 and 92.1)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Show which metadata is available in the first spectrum</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>r.ms2_ctr_fts[<span class="dv">0</span>].metadata.keys()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>dict_keys(['precursor_mz', 'precursor_intensity', 'charge', 'retention_time', 'collision_energy', 'isolation_window_target_mz', 'ms_level'])</code></pre>
</div>
</div>
<p>Second, we translate the <code>Spectra</code> object <code>ms2_ctr_fts</code> to respective Python <code>matchms.Spectrum</code> objects using the <code><a href="https://rdrr.io/pkg/SpectriPy/man/conversion.html" class="external-link">rspec_to_pyspec()</a></code> function. With the <code><a href="https://rstudio.github.io/reticulate/reference/py_set_attr.html" class="external-link">py_set_attr()</a></code> function we assign the variable directly to an attribute in the Python session (which avoids repeated cross-programming language references).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' R session:</span></span>
<span></span>
<span><span class="co">#' Add mapping for additional spectra variables to the default mapping in R and</span></span>
<span><span class="co">#' python, respectively</span></span>
<span><span class="va">map</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SpectriPy/man/conversion.html" class="external-link">defaultSpectraVariableMapping</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        feature_id <span class="op">=</span> <span class="st">'feature_id'</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Convert to py Spectrum</span></span>
<span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_set_attr.html" class="external-link">py_set_attr</a></span><span class="op">(</span><span class="va">py</span>, <span class="st">"ms2_ctr_fts_py"</span>, <span class="fu"><a href="https://rdrr.io/pkg/SpectriPy/man/conversion.html" class="external-link">rspec_to_pyspec</a></span><span class="op">(</span><span class="va">ms2_ctr_fts</span>, mapping <span class="op">=</span> <span class="va">map</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We can now access the converted <code>Spectra</code> object in Python.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Python session:</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Access the first converted spectrum</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>ms2_ctr_fts_py[<span class="dv">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Spectrum(precursor m/z=138.05, 4 fragments between 73.1 and 92.1)</code></pre>
</div>
</div>
</section><section class="section level2"><h2 id="filter-the-reference-library">Filter the reference library<a class="anchor" aria-label="anchor" href="#filter-the-reference-library"></a>
</h2>
<p>Before we run the spectral comparisons of our query data to the MGF reference library, we first apply some MS2 processing from <em>matchms</em>. Default filtering from <em>matchms</em> is performed to standardize ion mode, correct charge and more. See the <a href="https://matchms.readthedocs.io/en/latest/api/matchms.filtering.html" class="external-link">matchms filtering documentation</a>. Also, we keep only reference spectra with a precursor m/z as the similarity algorithm we use later requires spectra to have a precursor m/z.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Python session:</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matchms.filtering <span class="im">import</span> default_filters, normalize_intensities, add_parent_mass</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' Apply filters to clean and enhance each spectrum</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>clean_mgf_py <span class="op">=</span> []</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> spectrum <span class="kw">in</span> mgf_py:</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' Apply default filter to standardize ion mode, correct charge and more.</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' Default filter is fully explained at</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' https://matchms.readthedocs.io/en/latest/api/matchms.filtering.html</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    spectrum <span class="op">=</span> default_filters(spectrum)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' For missing precursor_mz field: check if there is “pepmass”” entry instead</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    spectrum <span class="op">=</span> add_parent_mass(spectrum)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' Scale peak intensities to maximum of 1</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    spectrum <span class="op">=</span> normalize_intensities(spectrum)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' Only add spectra that have a precursor m/z</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"precursor_mz"</span> <span class="kw">in</span> spectrum.metadata:</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>        clean_mgf_py.append(spectrum)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="co">#' Nr of spectra</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(clean_mgf_py)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code><span><span class="fl">78</span></span></code></pre>
</div>
</div>
</section><section class="section level2"><h2 id="calculating-spectra-similarities-using-the-modified-cosine-algorithm-from-matchms">Calculating spectra similarities using the Modified Cosine algorithm from <em>matchms</em>
<a class="anchor" aria-label="anchor" href="#calculating-spectra-similarities-using-the-modified-cosine-algorithm-from-matchms"></a>
</h2>
<p>We calculate the pairwise spectral similarity between the query spectra and the reference library spectra using Python’s <em>matchms</em> library.</p>
<p>Here, we use the spectral similarity algorithm ModifiedCosine from <em>matchms</em>, from source <a href="https://github.com/matchms/matchms/blob/master/README.rst" class="external-link">matchms</a>. This algorithm can easily be exchanged for another spectral similarity calculation from <em>matchms</em> (see <a href="https://matchms.readthedocs.io/en/latest/api/matchms.similarity.html" class="external-link">here</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Python session:</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matchms <span class="im">import</span> calculate_scores</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matchms.similarity <span class="im">import</span> ModifiedCosine</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' Calculate Cosine similarity scores between all spectra</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' For other similarity score methods see</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' https://matchms.readthedocs.io/en/latest/api/matchms.similarity.html</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>similarity_score <span class="op">=</span> ModifiedCosine(tolerance <span class="op">=</span> <span class="fl">0.1</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> calculate_scores(references <span class="op">=</span> clean_mgf_py,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>                          queries <span class="op">=</span> ms2_ctr_fts_py,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>                          similarity_function <span class="op">=</span> similarity_score)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Calculating similarities:   0%|          | 0/78 [00:00&lt;?, ?it/s]
Calculating similarities:   1%|1         | 1/78 [00:01&lt;02:11,  1.70s/it]
Calculating similarities:  10%|#         | 8/78 [00:01&lt;00:11,  5.91it/s]
Calculating similarities:  19%|#9        | 15/78 [00:01&lt;00:05, 12.10it/s]
Calculating similarities:  28%|##8       | 22/78 [00:02&lt;00:02, 19.05it/s]
Calculating similarities:  38%|###8      | 30/78 [00:02&lt;00:01, 27.60it/s]
Calculating similarities:  47%|####7     | 37/78 [00:02&lt;00:01, 34.20it/s]
Calculating similarities:  56%|#####6    | 44/78 [00:02&lt;00:01, 33.45it/s]
Calculating similarities:  64%|######4   | 50/78 [00:02&lt;00:00, 37.48it/s]
Calculating similarities:  73%|#######3  | 57/78 [00:02&lt;00:00, 43.48it/s]
Calculating similarities:  82%|########2 | 64/78 [00:02&lt;00:00, 48.62it/s]
Calculating similarities:  91%|#########1| 71/78 [00:02&lt;00:00, 53.64it/s]
Calculating similarities: 100%|##########| 78/78 [00:03&lt;00:00, 56.73it/s]
Calculating similarities: 100%|##########| 78/78 [00:03&lt;00:00, 25.93it/s]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>scores</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;78x291x2 stacked sparse array containing scores for ('ModifiedCosine_score', 'ModifiedCosine_matches') with 12376 stored elements in COOrdinate format&gt;</code></pre>
</div>
</div>
<p>We next rearrange the spectra similarity results to make a data frame containing the best matched compound name (derived from the reference library) per queried spectrum.</p>
<p>First, we extract and transpose the scores as a python array. Each row of the array will contain the similarity scores of one spectrum from our query spectra <code>ms2_ctr_fts_py</code> against the cleaned reference library <code>clean_mgf_py</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Python session:</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Convert to array and transpose</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>sim_matchms <span class="op">=</span> scores.to_array()[<span class="st">"ModifiedCosine_score"</span>]</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>sim_matchms <span class="op">=</span> sim_matchms.T</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' Contains 1 row for each spectrum in query</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>sim_matchms.shape</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(291, 78)</code></pre>
</div>
</div>
<p>Next, we create a data frame with per queried spectrum from our unknown variables, the compound name of the higest matching spectra from the reference library and the corresponding similarity score.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Python session:</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' Prepare results list</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(sim_matchms.shape[<span class="dv">0</span>]):</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' row is the query, keep nr in the results instead of replacing by eg id</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    name_row <span class="op">=</span> ms2_ctr_fts_py[i].get(<span class="st">'feature_id'</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    row_values <span class="op">=</span> sim_matchms[i].copy()</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' match with higest col nr from the references</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    max_col <span class="op">=</span> np.argmax(row_values)  <span class="co">#' Find column index of max value</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    max_value <span class="op">=</span> row_values[max_col]  <span class="co">#' Get max value</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' replace the nr of refererences with the name</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    name_max_col <span class="op">=</span> clean_mgf_py[max_col].get(<span class="st">'compound_name'</span>)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    results.append({<span class="st">"query"</span>: i <span class="op">+</span> <span class="dv">1</span>,</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"query_feature_id"</span>: name_row,</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"reference"</span>: max_col,</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"reference_compound_name"</span>: name_max_col,</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"ModifiedCosine_score"</span>: max_value})</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="co">#' Convert to DataFrame</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(results)</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="co">#' Print the first 5 rows of the unfiltered DataFrame</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>df.head()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   query query_feature_id  ...  reference_compound_name ModifiedCosine_score
0      1           FT0371  ...         Benzyl succinate             0.554071
1      2           FT0371  ...         Benzyl succinate             0.557885
2      3           FT0371  ...      L-(+)-Ergothioneine             0.103269
3      4           FT0371  ...         Benzyl succinate             0.464949
4      5           FT0371  ...         Benzyl succinate             0.508411

[5 rows x 5 columns]</code></pre>
</div>
</div>
<p>[!] <strong>Caution</strong>: As the higest score is taken as criteria for the annotation, a lot of caution is needed evaluation the trueness of the match. A low score is not reliable, as the similarity algorithm will calculate a score for each pair of spectra. Therefore, a match will always be found. In addition, if your unknown compound is absent in the reference library, it will match wrongly to another compound that is present in the database.</p>
<p>Below we filter the results retaining only matches with a similarity value above 0.6. Above this value, the potential annotations need to be validated using e.g. rerunning samples in the presence of commercial standards.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Python session:</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Keep only rows where score &gt;= 0.6</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>df_filtered <span class="op">=</span> df[df[<span class="st">"ModifiedCosine_score"</span>] <span class="op">&gt;=</span> <span class="fl">0.6</span>]</span></code></pre></div>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' R session:</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rapporter.github.io/pander/" class="external-link">pander</a></span><span class="op">)</span></span>
<span><span class="co">#' Print the filtered DataFrame</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.table.return.html" class="external-link">pandoc.table</a></span><span class="op">(</span><span class="va">py</span><span class="op">$</span><span class="va">df_filtered</span>, style <span class="op">=</span> <span class="st">"rmarkdown"</span>, split.table <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span></code></pre></div>
<table class="table caption-top">
<colgroup>
<col style="width: 8%">
<col style="width: 6%">
<col style="width: 16%">
<col style="width: 10%">
<col style="width: 36%">
<col style="width: 20%">
</colgroup>
<thead><tr class="header">
<th style="text-align: center;"> </th>
<th style="text-align: center;">query</th>
<th style="text-align: center;">query_feature_id</th>
<th style="text-align: center;">reference</th>
<th style="text-align: center;">reference_compound_name</th>
<th style="text-align: center;">ModifiedCosine_score</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>14</strong></td>
<td style="text-align: center;">15</td>
<td style="text-align: center;">FT0371</td>
<td style="text-align: center;">52</td>
<td style="text-align: center;">Nordihydroguaiaretic acid</td>
<td style="text-align: center;">0.6667</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>33</strong></td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">FT0565</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Ethambutol</td>
<td style="text-align: center;">0.9623</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>34</strong></td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">FT0565</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Ethambutol</td>
<td style="text-align: center;">0.8809</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>37</strong></td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">FT0565</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Ethambutol</td>
<td style="text-align: center;">0.9412</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>38</strong></td>
<td style="text-align: center;">39</td>
<td style="text-align: center;">FT0565</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Ethambutol</td>
<td style="text-align: center;">0.8681</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>40</strong></td>
<td style="text-align: center;">41</td>
<td style="text-align: center;">FT0565</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Ethambutol</td>
<td style="text-align: center;">0.935</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>41</strong></td>
<td style="text-align: center;">42</td>
<td style="text-align: center;">FT0565</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Ethambutol</td>
<td style="text-align: center;">0.7319</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>44</strong></td>
<td style="text-align: center;">45</td>
<td style="text-align: center;">FT0565</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Ethambutol</td>
<td style="text-align: center;">0.89</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>48</strong></td>
<td style="text-align: center;">49</td>
<td style="text-align: center;">FT0565</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Ethambutol</td>
<td style="text-align: center;">0.6822</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>51</strong></td>
<td style="text-align: center;">52</td>
<td style="text-align: center;">FT0565</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Benzyl succinate</td>
<td style="text-align: center;">0.7218</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>52</strong></td>
<td style="text-align: center;">53</td>
<td style="text-align: center;">FT0565</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Benzyl succinate</td>
<td style="text-align: center;">0.7516</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>53</strong></td>
<td style="text-align: center;">54</td>
<td style="text-align: center;">FT0565</td>
<td style="text-align: center;">47</td>
<td style="text-align: center;">Bisphenol AF</td>
<td style="text-align: center;">0.6977</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>56</strong></td>
<td style="text-align: center;">57</td>
<td style="text-align: center;">FT0565</td>
<td style="text-align: center;">39</td>
<td style="text-align: center;">Isethionate</td>
<td style="text-align: center;">0.6666</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>57</strong></td>
<td style="text-align: center;">58</td>
<td style="text-align: center;">FT0565</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Benzyl succinate</td>
<td style="text-align: center;">0.7443</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>67</strong></td>
<td style="text-align: center;">68</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">Prednisolone_Tebutate</td>
<td style="text-align: center;">0.7048</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>68</strong></td>
<td style="text-align: center;">69</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">Prednisolone_Tebutate</td>
<td style="text-align: center;">0.7729</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>70</strong></td>
<td style="text-align: center;">71</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">Prednisolone_Tebutate</td>
<td style="text-align: center;">0.7103</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>71</strong></td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">Prednisolone_Tebutate</td>
<td style="text-align: center;">0.6087</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>73</strong></td>
<td style="text-align: center;">74</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">Prednisolone_Tebutate</td>
<td style="text-align: center;">0.6523</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>74</strong></td>
<td style="text-align: center;">75</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">Prednisolone_Tebutate</td>
<td style="text-align: center;">0.8334</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>87</strong></td>
<td style="text-align: center;">88</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">19</td>
<td style="text-align: center;">Isoproturon-didemethyl</td>
<td style="text-align: center;">0.6235</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>89</strong></td>
<td style="text-align: center;">90</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">Prednisolone_Tebutate</td>
<td style="text-align: center;">0.6793</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>97</strong></td>
<td style="text-align: center;">98</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">N-Methyl-2-pyrrolidone</td>
<td style="text-align: center;">0.7953</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>103</strong></td>
<td style="text-align: center;">104</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">Prednisolone_Tebutate</td>
<td style="text-align: center;">0.6041</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>104</strong></td>
<td style="text-align: center;">105</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">Prednisolone_Tebutate</td>
<td style="text-align: center;">0.6836</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>109</strong></td>
<td style="text-align: center;">110</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">Prednisolone_Tebutate</td>
<td style="text-align: center;">0.6295</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>111</strong></td>
<td style="text-align: center;">112</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.6005</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>112</strong></td>
<td style="text-align: center;">113</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">16</td>
<td style="text-align: center;">Caffeine</td>
<td style="text-align: center;">0.6181</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>113</strong></td>
<td style="text-align: center;">114</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.6843</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>125</strong></td>
<td style="text-align: center;">126</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.6863</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>126</strong></td>
<td style="text-align: center;">127</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.7172</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>127</strong></td>
<td style="text-align: center;">128</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.7157</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>128</strong></td>
<td style="text-align: center;">129</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.721</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>129</strong></td>
<td style="text-align: center;">130</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.6315</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>134</strong></td>
<td style="text-align: center;">135</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">Prednisolone_Tebutate</td>
<td style="text-align: center;">0.7612</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>137</strong></td>
<td style="text-align: center;">138</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.6478</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>139</strong></td>
<td style="text-align: center;">140</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.6301</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>140</strong></td>
<td style="text-align: center;">141</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.7013</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>141</strong></td>
<td style="text-align: center;">142</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.7017</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>142</strong></td>
<td style="text-align: center;">143</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.7018</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>143</strong></td>
<td style="text-align: center;">144</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.7863</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>186</strong></td>
<td style="text-align: center;">187</td>
<td style="text-align: center;">FT0732</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">N-Methyl-2-pyrrolidone</td>
<td style="text-align: center;">0.636</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>220</strong></td>
<td style="text-align: center;">221</td>
<td style="text-align: center;">FT0845</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.737</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>221</strong></td>
<td style="text-align: center;">222</td>
<td style="text-align: center;">FT0845</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.733</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>222</strong></td>
<td style="text-align: center;">223</td>
<td style="text-align: center;">FT0845</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.7256</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>223</strong></td>
<td style="text-align: center;">224</td>
<td style="text-align: center;">FT0845</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.7305</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>227</strong></td>
<td style="text-align: center;">228</td>
<td style="text-align: center;">FT0845</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.6283</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>228</strong></td>
<td style="text-align: center;">229</td>
<td style="text-align: center;">FT0845</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.7359</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>229</strong></td>
<td style="text-align: center;">230</td>
<td style="text-align: center;">FT0845</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.7296</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>230</strong></td>
<td style="text-align: center;">231</td>
<td style="text-align: center;">FT0845</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.73</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>239</strong></td>
<td style="text-align: center;">240</td>
<td style="text-align: center;">FT0845</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.7352</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>240</strong></td>
<td style="text-align: center;">241</td>
<td style="text-align: center;">FT0845</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.7351</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>247</strong></td>
<td style="text-align: center;">248</td>
<td style="text-align: center;">FT0845</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.7391</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>248</strong></td>
<td style="text-align: center;">249</td>
<td style="text-align: center;">FT0845</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">3-(4-Isopropylphenyl)isobutyraldehyde</td>
<td style="text-align: center;">0.7332</td>
</tr>
</tbody>
</table>
<p>To visually inspect how good the query and reference spectra match, we refer to the <a href="https://rformassspectrometry.github.io/Metabonaut/articles/end-to-end-untargeted-metabolomics.html">Metabonaut resource</a> on how to generate the mirror plots and perform precursor <em>m/z</em> filtering (e.g. maximum 1 Da difference).</p>
</section><section class="section level2"><h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' R session:</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.1 (2025-06-13)
Platform: x86_64-pc-linux-gnu
Running under: Ubuntu 24.04.2 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3
LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C
 [9] LC_ADDRESS=C               LC_TELEPHONE=C
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C

time zone: Etc/UTC
tzcode source: system (glibc)

attached base packages:
[1] stats4    stats     graphics  grDevices utils     datasets  methods
[8] base

other attached packages:
[1] pander_0.6.6        Spectra_1.18.2      BiocParallel_1.42.1
[4] S4Vectors_0.46.0    BiocGenerics_0.54.0 generics_0.1.4
[7] SpectriPy_0.99.5    reticulate_1.42.0

loaded via a namespace (and not attached):
 [1] cli_3.6.5              knitr_1.50             rlang_1.1.6
 [4] xfun_0.52              ProtGenerics_1.40.0    png_0.1-8
 [7] jsonlite_2.0.0         clue_0.3-66            htmltools_0.5.8.1
[10] rmarkdown_2.29         grid_4.5.1             evaluate_1.0.4
[13] MASS_7.3-65            fastmap_1.2.0          yaml_2.3.10
[16] IRanges_2.42.0         MsCoreUtils_1.20.0     cluster_2.1.8.1
[19] compiler_4.5.1         codetools_0.2-20       fs_1.6.6
[22] Rcpp_1.1.0             MetaboCoreUtils_1.16.1 lattice_0.22-7
[25] digest_0.6.37          parallel_4.5.1         Matrix_1.7-3
[28] tools_4.5.1           </code></pre>
</div>
</div>
</section><section class="section level2"><h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-graeve_spectripy_2025" class="csl-entry" role="listitem">
Graeve, Marilyn De, Wout Bittremieux, Thomas Naake, Carolin Huber, Matthias Anagho-Mattanovich, Nils Hoffmann, Pierre Marchal, et al. 2025. <span>“<span>SpectriPy</span>: <span>Enhancing</span> <span>Cross</span>-<span>Language</span> <span>Mass</span> <span>Spectrometry</span> <span>Data</span> <span>Analysis</span> with <span>R</span> and <span>Python</span>.”</span> <em>Journal of Open Source Software</em> 10 (109): 8070. <a href="https://doi.org/10.21105/joss.08070" class="external-link">https://doi.org/10.21105/joss.08070</a>.
</div>
<div id="ref-huber_matchms_2020" class="csl-entry" role="listitem">
Huber, Florian, Stefan Verhoeven, Christiaan Meijer, Hanno Spreeuw, Efraín Castilla, Cunliang Geng, Justin Van Der Hooft, et al. 2020. <span>“Matchms - Processing and Similarity Evaluation of Mass Spectrometry Data.”</span> <em>Journal of Open Source Software</em> 5 (52): 2411. <a href="https://doi.org/10.21105/joss.02411" class="external-link">https://doi.org/10.21105/joss.02411</a>.
</div>
<div id="ref-louail_metabonaut_2025" class="csl-entry" role="listitem">
Louail, Philippine, and Johannes Rainer. 2025. <span>“Rformassspectrometry/Metabonaut: Metabonaut Version 1.0.0.”</span> Zenodo. <a href="https://doi.org/10.5281/ZENODO.15062930" class="external-link">https://doi.org/10.5281/ZENODO.15062930</a>.
</div>
</div>
</section><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'light-border',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config);
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script></main>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philippine Louail, Johannes Rainer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
