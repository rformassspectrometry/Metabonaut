<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using and Creating Metabolomics Data Annotation Resources • Metabonaut</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="creating-using-annotation-resources_files/libs/quarto-html/popper.min.js"></script><script src="creating-using-annotation-resources_files/libs/quarto-html/tippy.umd.min.js"></script><link href="creating-using-annotation-resources_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="creating-using-annotation-resources_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using and Creating Metabolomics Data Annotation Resources">
<meta property="og:image" content="https://rformassspectrometry.github.io/Metabonaut/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Metabonaut</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.5.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/install_v0.html">Installation instructions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-workflows" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Workflows</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-workflows">
<li><a class="dropdown-item" href="../articles/a-end-to-end-untargeted-metabolomics.html">End-to-end workflow for untargeted metabolomics data analysis in R</a></li>
    <li><a class="dropdown-item" href="../articles/notame_normalization_and_feature_selection.html">Quality control and Feature selection with Notame</a></li>
    <li><a class="dropdown-item" href="../articles/dataset-investigation.html">Dataset investigation: What to do when you get your data</a></li>
    <li><a class="dropdown-item" href="../articles/alignment-to-external-dataset.html">Seamless Alignment: Merging New data with Existing Preprocessed Datasets</a></li>
    <li><a class="dropdown-item" href="../articles/SpectriPy-tutorial-metabonaut.html">LC-MS/MS Data Annotation using R and Python</a></li>
    <li><a class="dropdown-item" href="../articles/large-scale-analysis.html">Large Scale Data Preprocessing with xcms</a></li>
    <li><a class="dropdown-item" href="../articles/creating-using-annotation-resources.html">Using and Creating Metabolomics Data Annotation Resources</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rformassspectrometry/Metabonaut/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Using and Creating Metabolomics Data Annotation Resources</h1>

      <p class="author">Philippine Louail, Johannes Rainer</p>
      <p class="date">2026-02-03</p>

      <small class="dont-index">Source: <a href="https://github.com/rformassspectrometry/Metabonaut/blob/devel/vignettes/creating-using-annotation-resources.qmd" class="external-link"><code>vignettes/creating-using-annotation-resources.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <section class="section level2"><h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This document shows how to access, use, and build annotation resources for untargeted metabolomics data. Reference spectral libraries are available from several sources, including:</p>
<ul>
<li>
<a href="https://gnps.ucsd.edu/ProteoSAFe/static/gnps-splash.jsp" class="external-link">GNPS</a>: the Global Natural Products Social Molecular Networking (GNPS) is an open-access knowledge base for community-wide organization and sharing of raw, processed or identified MS/MS spectrometry data <span class="citation" data-cites="wang_sharing_2016">(<a href="#ref-wang_sharing_2016" role="doc-biblioref">Wang et al. 2016</a>)</span>.</li>
<li>
<a href="https://massbank.eu/MassBank/" class="external-link">MassBank</a>: MassBank is an open source mass spectral library for the identification of small chemical molecules of metabolomics, exposomics and environmental relevance <span class="citation" data-cites="neumann_massbank_2025">(<a href="#ref-neumann_massbank_2025" role="doc-biblioref">Neumann et al. 2025</a>)</span>.</li>
<li>
<a href="https://www.hmdb.ca/" class="external-link">HMDB</a>: the Human Metabolome Database (HMDB) is a freely available electronic database containing detailed information about small molecule metabolites found in the human body <span class="citation" data-cites="wishart_hmdb_2021">(<a href="#ref-wishart_hmdb_2021" role="doc-biblioref">Wishart et al. 2021</a>)</span>.</li>
<li>
<a href="https://mona.fiehnlab.ucdavis.edu/" class="external-link">MoNA</a>: MassBank of North America (MoNA) is a metadata-centric, auto-curating repository for efficient storage and querying of mass spectral records.</li>
</ul>
<p>Across resources, file formats, naming, and available annotations differ, so imports can be cumbersome. Packages exist for most formats, but harmonization remains challenging. Here we import public spectral libraries into data structures suitable for LC-MS/MS annotation, extract metadata, and outline future work toward harmonized formats such as <a href="https://github.com/HUPO-PSI/mzSpecLib" class="external-link"><em>mzSpecLib</em></a>.</p>
</section><section class="section level2"><h2 id="accessing-and-using-spectral-libraries">Accessing and using spectral libraries<a class="anchor" aria-label="anchor" href="#accessing-and-using-spectral-libraries"></a>
</h2>
<p>Spectral libraries come in different formats. Packages from the <em>RforMassSpectrometry</em> initiative (<em><a href="https://bioconductor.org/packages/3.22/MsBackendMgf" class="external-link">MsBackendMgf</a></em>, <code>r Biocpkg("MsBackendMsp")</code>, <em><a href="https://bioconductor.org/packages/3.22/MsBackendMassbank" class="external-link">MsBackendMassbank</a></em>, <code>r Biocpkg("CompoundDb")</code>) parse these formats into <code>Spectra</code> objects ready for R-based workflows. Below we load GNPS and MassBank libraries for LC-MS/MS annotation.</p>
<section class="level2"><h3 id="using-spectral-libraries-from-gnps">Using spectral libraries from GNPS<a class="anchor" aria-label="anchor" href="#using-spectral-libraries-from-gnps"></a>
</h3>
<p><a href="https://gnps2.org" class="external-link">GNPS2</a> provides MS/MS spectral libraries, integrating data from sources such as <a href="https://massbank.eu/MassBank/" class="external-link">MassBank</a> and <a href="https://mona.fiehnlab.ucdavis.edu/" class="external-link">MoNA</a>. Libraries are available as MGF, MSP, or JSON from the <a href="https://external.gnps2.org/gnpslibrary" class="external-link">GNPS2 site</a> and on Zenodo or Figshare with their own DOIs.</p>
<p>Here we download the GNPS2 drug library from <a href="https://doi.org/10.5281/zenodo.13892288" class="external-link">Zenodo</a>, a centralized collection of drug spectra with pharmacologic metadata <span class="citation" data-cites="zhao_resource_2025">(<a href="#ref-zhao_resource_2025" role="doc-biblioref">Zhao et al. 2025</a>)</span>. We fetch all v4 resources (DOI: 10.5281/zenodo.17232042) to a temporary folder.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link">Spectra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/eblondel/zen4R" class="external-link">zen4R</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">doi</span> <span class="op">&lt;-</span> <span class="st">"10.5281/zenodo.17232042"</span> <span class="co"># v4</span></span>
<span></span>
<span><span class="co">#' download all data related to the DOI</span></span>
<span><span class="va">pth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/zen4R/man/download_zenodo.html" class="external-link">download_zenodo</a></span><span class="op">(</span><span class="va">doi</span>, path <span class="op">=</span> <span class="va">pth</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span>, timeout <span class="op">=</span> <span class="fl">600</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">pth</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "GNPS_Drug_Library_Metadata_Drug_Analogs_Updated_With_Source.csv"
[2] "GNPS_Drug_Library_Metadata_Drugs.csv"
[3] "GNPS_Drug_Library_Spectra_Drug_Analogs_Updated.mgf"
[4] "GNPS_Drug_Library_Spectra_Drugs_and_Metabolites.mgf"            </code></pre>
</div>
</div>
<p>The spectral libraries are available in MGF file format. Below we read the first 25 lines of the MGF file to inspect the available spectrum metadata fields.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mgf_fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pth</span>, <span class="st">"GNPS_Drug_Library_Spectra_Drugs_and_Metabolites.mgf"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">mgf_fl</span>, n <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "BEGIN IONS"
 [2] "PEPMASS=656.306"
 [3] "CHARGE=1"
 [4] "MSLEVEL=2"
 [5] "SOURCE_INSTRUMENT=LC-ESI-qTof"
 [6] "FILENAME=d10.mgf"
 [7] "SEQ=*..*"
 [8] "IONMODE=Positive"
 [9] "ORGANISM=GNPS-LIBRARY"
[10] "NAME=Rifamycin W M+H"
[11] "PI=Fenical-Jensen-Moore"
[12] "DATACOLLECTOR=Max"
[13] "SMILES=C[C@H]1/C=C/C=C(\\C(=O)NC2=CC(=O)C3=C(C(=C(C(=C3C2=O)O)C)O)C(=O)/C(=C/[C@@H]([C@@H]([C@H]([C@H]([C@@H]([C@@H]([C@@H]([C@H]1O)C)O)C)O)C)O)CO)/C)/C"
[14] "INCHI=InChI=1S/C35H45NO11/c1-14-9-8-10-15(2)35(47)36-22-12-23(38)24-25(32(44)20(7)33(45)26(24)34(22)46)28(40)16(3)11-21(13-37)31(43)19(6)30(42)18(5)29(41)17(4)27(14)39/h8-12,14,17-19,21,27,29-31,37,39,41-45H,13H2,1-7H3,(H,36,47)/b9-8+,15-10-,16-11+/t14-,17+,18+,19-,21+,27-,29+,30-,31+/m0/s1"
[15] "INCHIAUX=N/A"
[16] "PUBMED=N/A"
[17] "SUBMITUSER=mwang87"
[18] "LIBRARYQUALITY=1"
[19] "SPECTRUMID=CCMSLIB00000001635"
[20] "SCANS=1"
[21] "51.022472\t93.906502"
[22] "53.03849\t152.1483"
[23] "55.017834\t226.064896"
[24] "55.054722\t2069.459961"
[25] "56.056667\t98.109642"                                                                                                                                                                                                                                                                               </code></pre>
</div>
</div>
<p>The MGF format allows having additional fields to provide spectra metadata on top of mandatory fields such as <em>PEPMASS</em> (for precursor <em>m/z</em>) or <em>CHARGE</em> (for the precursor’s charge). MGF files can be imported into a <code>Spectra</code> object using the <em><a href="https://bioconductor.org/packages/3.22/MsBackendMgf" class="external-link">MsBackendMgf</a></em>, which supports import of all metadata fields, renaming and mapping them to specific spectra variables. Below we define such a variable name mapping to map e.g. <em>MSLEVEL</em> to the spectra variable <code>msLevel</code> and <em>NAME</em> to <em>spectrum_name</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendMgf" class="external-link">MsBackendMgf</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Get the default spectra variable mapping</span></span>
<span><span class="va">svm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectraVariableMapping.html" class="external-link">spectraVariableMapping</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/MsBackendMgf/man/MsBackendMgf.html" class="external-link">MsBackendMgf</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#' Add additional, custom, mappings</span></span>
<span><span class="va">svm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">svm</span>,</span>
<span>         msLevel <span class="op">=</span> <span class="st">"MSLEVEL"</span>,</span>
<span>         spectrum_name <span class="op">=</span> <span class="st">"NAME"</span>,</span>
<span>         inchi <span class="op">=</span> <span class="st">"INCHI"</span>,</span>
<span>         smiles <span class="op">=</span> <span class="st">"SMILES"</span>,</span>
<span>         exactmass <span class="op">=</span> <span class="st">"EXACTMASS"</span></span>
<span>         <span class="op">)</span></span></code></pre></div>
</div>
<p>We next import the MGF file into a <code>Spectra</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' import the MGF file</span></span>
<span><span class="va">drug_ms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">mgf_fl</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendMgf/man/MsBackendMgf.html" class="external-link">MsBackendMgf</a></span><span class="op">(</span><span class="op">)</span>, mapping <span class="op">=</span> <span class="va">svm</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start data import from 1 files ... done</code></pre>
</div>
</div>
<p>We convert <code>IONMODE</code> from <code>"Positive"</code>/<code>"Negative"</code> to the standard <code>polarity</code> encoding (<code>1</code>/<code>0</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drug_ms2</span><span class="op">$</span><span class="va">polarity</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">drug_ms2</span><span class="op">$</span><span class="va">IONMODE</span> <span class="op">==</span> <span class="st">"Positive"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1L</span></span>
<span><span class="va">drug_ms2</span><span class="op">$</span><span class="va">polarity</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">drug_ms2</span><span class="op">$</span><span class="va">IONMODE</span> <span class="op">==</span> <span class="st">"Negative"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0L</span></span></code></pre></div>
</div>
<p>Compound annotations are sparse in the imported library. Spectrum names hold the compound, adduct, and sometimes collision energy, but formatting is inconsistent:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drug_ms2</span><span class="op">$</span><span class="va">spectrum_name</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Rifamycin W M+H"   "Rifamycin W M+Na"  "Dolastatin_10 M+H"
[4] "Rifamycin S M+Na"  "Rifamycin S M+H"   "phenazine M+H"    </code></pre>
</div>
</div>
<p>For these compounds, no charge or polarity information is provided, while for other compounds the adduct encoding follows more the standardized format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drug_ms2</span><span class="op">$</span><span class="va">spectrum_name</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "TRIMEBUTINE_metabolite_031 [[M+H]+]" "TRIMEDLURE [[M+H]+]"
[3] "TRIMEDLURE [[M+Na]+]"                "TRIMEDLURE [[M+K]+]"
[5] "TRIMEDLURE [[M+H-H2O]+]"             "Bictegravir [[M+H]+]"               </code></pre>
</div>
</div>
<p>First examples how to extract and parse the adduct information are provided in the next section. For the present examples we simply use the data as provided. We first plot the first 4 reference spectra from the library.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectra</a></span><span class="op">(</span><span class="va">drug_ms2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure><p><img src="creating-using-annotation-resources_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Two things stand out: intensities are <em>absolute</em>, and a large number of low-abundance peaks are present likely reflecting instrument noise. We remove peaks below 1% of the maximum and scale intensities to sum to 1. This is one possible cleaning choice, not a standard.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drug_ms2</span> <span class="op">&lt;-</span> <span class="va">drug_ms2</span> <span class="op">|&gt;</span></span>
<span>    <span class="co">#' remove peaks with intensity &lt; 1% max intensity</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterIntensity</a></span><span class="op">(</span>intensity <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">x</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span> <span class="fl">100</span></span>
<span>    <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co">#' scale intensities to a total sum of 1</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/addProcessing.html" class="external-link">scalePeaks</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We plot the first 4 spectra again to evaluate the impact of this processing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectra</a></span><span class="op">(</span><span class="va">drug_ms2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure><p><img src="creating-using-annotation-resources_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The number of fragment peaks per spectrum was thus reduced and intensities are now relative to the total intensity sum.</p>
<p>This <code>Spectra</code> object can now be used to match MS/MS spectra from the <em>Complete end-to-end LC-MS/MS metabolomics data analysis</em> workflow. We load the example <code>Spectra</code> object below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' load the MS2 spectra for significant features</span></span>
<span><span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"spectra_significant_fts.RData"</span>,</span>
<span>                  package <span class="op">=</span> <span class="st">"Metabonaut"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="va">fl</span><span class="op">)</span> <span class="co"># ms2_ctr_fts</span></span>
<span><span class="va">ms2_ctr_fts</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MSn data (Spectra) with 315 spectra in a MsBackendMemory backend:
      msLevel     rtime scanIndex
    &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
1           2   147.357      2043
2           2   148.587      2061
3           2   149.817      2079
4           2   152.297      2115
5           2   147.376      2041
...       ...       ...       ...
311         2   178.082      2481
312         2   179.322      2499
313         2   180.572      2517
314         2   181.822      2535
315         2   183.072      2553
 ... 39 more variables/columns.
Processing:
 Filter: select retention time [10..240] on MS level(s) 1 2 [Tue Mar 18 11:56:42 2025]
 Filter: select MS level(s) 2 [Tue Mar 18 11:56:50 2025]
 Remove peaks based on their intensities and a user-provided function in spectra of MS level(s) 2. [Tue Mar 18 11:56:50 2025]
 ...19 more processings. Use 'processingLog' to list all. </code></pre>
</div>
</div>
<p>This <code>Spectra</code> object contains MS/MS spectra for features with significant abundance differences. We match them against the GNPS2 drug library with <em><a href="https://bioconductor.org/packages/3.22/MetaboAnnotation" class="external-link">MetaboAnnotation</a></em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' match the experimental spectra against the GNPS2 drug library</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MetaboAnnotation" class="external-link">MetaboAnnotation</a></span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/matchSpectra.html" class="external-link">matchSpectra</a></span><span class="op">(</span><span class="va">ms2_ctr_fts</span>, <span class="va">drug_ms2</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/CompareSpectraParam.html" class="external-link">CompareSpectraParam</a></span><span class="op">(</span>tolerance <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#' restrict data to matching spectra</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html" class="external-link">whichQuery</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html" class="external-link">pruneTarget</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
</div>
<p>And, not unexpectedly, most fragment spectra match to reference spectra for caffeine.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span><span class="op">$</span><span class="va">target_spectrum_name</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "caffeine M+H"
 [2] "Methazolastone M+H"
 [3] "1,3,7-trimethyl-3,7-dihydro-1H-purine-2,6-dione [M+H]+"
 [4] "Massbank:BML00705 Caffeine [M+H]+"
 [5] "Massbank:EA030301 Caffeine|1,3,7-trimethyl-3,7-dihydro-1H-purine-2,6-dione|1,3,7-trimethylpurine-2,6-dione [M+H]+"
 [6] "Massbank:EA030311 Caffeine|1,3,7-trimethyl-3,7-dihydro-1H-purine-2,6-dione|1,3,7-trimethylpurine-2,6-dione [M+H]+"
 [7] "Massbank:EA030312 Caffeine|1,3,7-trimethyl-3,7-dihydro-1H-purine-2,6-dione|1,3,7-trimethylpurine-2,6-dione [M+H]+"
 [8] "Massbank:EA030314 Caffeine|1,3,7-trimethyl-3,7-dihydro-1H-purine-2,6-dione|1,3,7-trimethylpurine-2,6-dione [M+H]+"
 [9] "Massbank:FIO00570 Caffeine [M+H]+"
[10] "Massbank:MT000087 Caffeine [M+H]+"
[11] "Massbank:UF408902 Caffeine|1,3,7-trimethyl-3,7-dihydro-1H-purine-2,6-dione|1,3,7-trimethylpurine-2,6-dione [M+H]+"
[12] "Massbank:UF408903 Caffeine|1,3,7-trimethyl-3,7-dihydro-1H-purine-2,6-dione|1,3,7-trimethylpurine-2,6-dione [M+H]+"
[13] "Massbank:UF408904 Caffeine|1,3,7-trimethyl-3,7-dihydro-1H-purine-2,6-dione|1,3,7-trimethylpurine-2,6-dione [M+H]+"
[14] "Massbank:KW107904 caffeine M+H"
[15] "Massbank:KW107901 caffeine M+H"
[16] "Massbank:LU119904 Caffeine|1,3,7-trimethylpurine-2,6-dione M+H"
[17] "MassbankEU:UA005001 Caffeine|1,3,7-trimethylpurine-2,6-dione [M+H]+"
[18] "Caffeine - 30.0 eV M+H"
[19] "CAFFEINE - 60.0 eV M+H"
[20] "Massbank:EA030306 Caffeine|1,3,7-trimethyl-3,7-dihydro-1H-purine-2,6-dione|1,3,7-trimethylpurine-2,6-dione [M+H]+"
[21] "CAFFEINE M+H"
[22] "CAFFEINE - 70.0 eV M+H"
[23] "Caffeine [M+H]+"
[24] "Massbank:EA030305 Caffeine|1,3,7-trimethyl-3,7-dihydro-1H-purine-2,6-dione|1,3,7-trimethylpurine-2,6-dione [M+H]+"
[25] "Massbank:EA030307 Caffeine|1,3,7-trimethyl-3,7-dihydro-1H-purine-2,6-dione|1,3,7-trimethylpurine-2,6-dione [M+H]+"
[26] "Massbank:EA030313 Caffeine|1,3,7-trimethyl-3,7-dihydro-1H-purine-2,6-dione|1,3,7-trimethylpurine-2,6-dione [M+H]+"
[27] "Massbank:LU119905 Caffeine|1,3,7-trimethylpurine-2,6-dione M+H"                                                   </code></pre>
</div>
</div>
<p>To summarize, through packages such as <em><a href="https://bioconductor.org/packages/3.22/MsBackendMgf" class="external-link">MsBackendMgf</a></em>, <code>r Biocpkg("MsBackendMsp")</code> it is easily possible to integrate public (or in-house) spectral reference libraries in MGF or MSP file format into R-based annotation workflows.</p>
<section class="level3"><h4 id="importing-and-cleaning-gnps-mgf-files-using-pythons-matchms-library">Importing and cleaning GNPS MGF files using Python’s <em>matchms</em> library<a class="anchor" aria-label="anchor" href="#importing-and-cleaning-gnps-mgf-files-using-pythons-matchms-library"></a>
</h4>
<p>Alternatively, it is possible to import and clean the GNPS MGF file in Python with <em>matchms</em> and access it in R through <code>MsBackendPy</code> from the <code>r Biocpkg("SpectriPy")</code> package <span class="citation" data-cites="graeve_spectripy_2025">(<a href="#ref-graeve_spectripy_2025" role="doc-biblioref">Graeve et al. 2025</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' load the required SpectriPy package; this will also install</span></span>
<span><span class="co">#' eventually required Python libraries and dependencies</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/SpectriPy" class="external-link">SpectriPy</a></span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: reticulate</code></pre>
</div>
</div>
<p>We next import the MGF file in Python using the <em>matchms</em> library <span class="citation" data-cites="huber_matchms_2020">(<a href="#ref-huber_matchms_2020" role="doc-biblioref">Huber et al. 2020</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matchms</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matchms.importing <span class="im">import</span> load_from_mgf</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' import the fragment spectra from the MGF file</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>s_py <span class="op">=</span> <span class="bu">list</span>(load_from_mgf(r.mgf_fl))</span></code></pre></div>
</div>
<p>Next we clean and harmonize metadata with <em>matchms</em> filters. See the <a href="https://matchms.readthedocs.io/en/latest/api/matchms.filtering.html" class="external-link"><em>matchms.filtering</em> documentation</a> or <span class="citation" data-cites="de_jonge_reproducible_2024">(<a href="#ref-de_jonge_reproducible_2024" role="doc-biblioref">Jonge et al. 2024</a>)</span> for options.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matchms.filtering <span class="im">import</span> default_filters, clean_adduct</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' apply filters to clean the spectra metadata</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>s_py_clean <span class="op">=</span> []</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> s <span class="kw">in</span> s_py:</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> default_filters(s)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> clean_adduct(s)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    s_py_clean.append(s)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' delete the unfiltered data</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> s_py</span></code></pre></div>
</div>
<p>To access the cleaned spectra data we create next a <code>Spectra</code> object using <em>SpectriPy</em>’s <code>MsBackendPy</code> backend.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' reference the MS data in R</span></span>
<span><span class="va">s_py</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="st">"s_py_clean"</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SpectriPy/man/MsBackendPy.html" class="external-link">MsBackendPy</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">s_py</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "msLevel"                 "rtime"
 [3] "acquisitionNum"          "scanIndex"
 [5] "dataStorage"             "dataOrigin"
 [7] "centroided"              "smoothed"
 [9] "polarity"                "precScanNum"
[11] "precursorMz"             "precursorIntensity"
[13] "precursorCharge"         "collisionEnergy"
[15] "isolationWindowLowerMz"  "isolationWindowTargetMz"
[17] "isolationWindowUpperMz"  "adduct"
[19] "compound_name"           "confidence"
[21] "data_collector"          "file_name"
[23] "inchi"                   "instrument_type"
[25] "ionmode"                 "organism_name"
[27] "peptide_sequence"        "principal_investigator"
[29] "scans"                   "smiles"
[31] "spectrum_id"             "submit_user"            </code></pre>
</div>
</div>
<p>The <em>adduct</em> information was now harmonized by the filtering workflow in Python:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' get the unique adduct types</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">s_py</span><span class="op">$</span><span class="va">adduct</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
         [2M-2H+Na]-              [2M-H]-           [2M-H+Na]-
                 139                  293                    1
          [2M+FA-H]-              [2M+H]+           [2M+K-2H]-
                   1                  253                    1
             [2M+K]+          [2M+Na-2H]-             [2M+Na]+
                  10                    1                  129
           [2M+NH4]+              [3M-H]-              [3M+H]+
                   4                    2                    1
            [3M+Na]+            [3M+NH4]+        [M-2(H2O)+H]+
                   1                    1                    1
             [M-2H]-             [M-2H]2-          [M-2H2O+H]+
                   1                   41                   84
         [M-3H2O+H]+               [M-e]-               [M-H]-
                   2                   12                12803
          [M-H+H2O]-         [M-H+HCOOH]-            [M-H+Na]+
                   1                    2                    6
          [M-H2O-H]-             [M-H2O]+           [M-H2O+H]+
                   1                    1                  531
                [M]+             [M+2H]2+           [M+2Na-H]+
                  88                  274                   55
           [M+2Na]2+             [M+3H]3+           [M+ACN+H]+
                   2                    1                    3
              [M+C]-             [M+Ca]2+          [M+CH3COO]-
                   1                    1                   20
[M+CH3COO]-/[M-CH3]-         [M+CH3OH+H]+              [M+Cl]-
                   7                    1                  162
           [M+FA-H]-          [M+H-3H2O]+         [M+H-C2H5N]+
                  11                    5                    1
         [M+H-C4H6]+       [M+H-C5H12N2]+       [M+H-C5H9NO4]+
                   1                    5                    1
          [M+H-H20]+           [M+H-NH3]+               [M+H]+
                   1                    4                68362
           [M+HCOO]-               [M+K]+              [M+Li]+
                  88                  465                    2
          [M+Na-2H]-              [M+Na]+             [M+NH4]+
                   2                13949                  551 </code></pre>
</div>
</div>
<p>The <code>s_py</code> <code>Spectra</code> object is ready for R workflows. Data stay in Python and is translated on demand; switch to <code>MsBackendMemory</code> to copy it to R if needed.</p>
</section></section><section class="level2"><h3 id="using-massbank-data">Using MassBank data<a class="anchor" aria-label="anchor" href="#using-massbank-data"></a>
</h3>
<p>MassBank was one of the first open-source and open access cross-vendor mass spectral libraries <span class="citation" data-cites="neumann_massbank_2025">(<a href="#ref-neumann_massbank_2025" role="doc-biblioref">Neumann et al. 2025</a>)</span>. All content, which is validated using automatic pipelines, is under version control and versioned releases are pushed to an independent data repository. The easiest way to use MassBank annotations in R is to get the respective database from Bioconductor’s <em>AnnotationHub</em>. This is also described in more detail in the <em>MS1-based annotation</em> section in the main <a href="https://rformassspectrometry.github.io/Metabonaut/articles/a-end-to-end-untargeted-metabolomics.html">end-to-end workflow</a>. Below we first load the respective library and the list of available annotations from AnnotationHub.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">AnnotationHub</span><span class="op">)</span></span>
<span><span class="co">#' load annotation metadata</span></span>
<span><span class="va">ah</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AnnotationHub/man/AnnotationHub-class.html" class="external-link">AnnotationHub</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<p>AnnotationHub can then be queried for MassBank records:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AnnotationHub/man/AnnotationHub-class.html" class="external-link">query</a></span><span class="op">(</span><span class="va">ah</span>, <span class="st">"MassBank"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span>, description <span class="op">=</span> <span class="va">mb</span><span class="op">$</span><span class="va">title</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        id                           description
1 AH107048   MassBank CompDb for release 2021.03
2 AH107049   MassBank CompDb for release 2022.06
3 AH111334 MassBank CompDb for release 2022.12.1
4 AH116164   MassBank CompDb for release 2023.06
5 AH116165   MassBank CompDb for release 2023.09
6 AH116166   MassBank CompDb for release 2023.11
7 AH119518   MassBank CompDb for release 2024.06
8 AH119519   MassBank CompDb for release 2024.11</code></pre>
</div>
</div>
<p>And a specific MassBank release can then be loaded using the respective AnnotationHub identifier. Below we load data from MassBank release <em>2023.11</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span> <span class="op">&lt;-</span> <span class="va">ah</span><span class="op">[[</span><span class="st">"AH116166"</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>loading from cache</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/RforMassSpectrometry/CompoundDb" class="external-link">"CompoundDb"</a></span><span class="op">)</span></span></code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class: CompDb
 data source: MassBank
 version: 2023.11
 organism: NA
 compound count: 117732
 MS/MS spectra count: 117732 </code></pre>
</div>
</div>
<p>The result is returned as a <code>CompDb</code> object from the <em><a href="https://bioconductor.org/packages/3.22/CompoundDb" class="external-link">CompoundDb</a></em> package which can be directly used with the annotation functions from the <code>r Biocpkg("MetaboAnnotation")</code> package. While this approach is convenient and fast, not all MassBank releases are available through <em>AnnotationHub</em>.</p>
<p>Alternatively, download MassBank data from the <a href="https://github.com/MassBank/MassBank-data/releases" class="external-link">MassBank GitHub page</a> or Zenodo. DOI <a href="https://doi.org/10.5281/zenodo.3378723" class="external-link">10.5281/zenodo.3378723</a> points to the latest release. Here we fetch release <em>2025.10</em> via DOI 10.5281/zenodo.17432277:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link">Spectra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/eblondel/zen4R" class="external-link">zen4R</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">doi</span> <span class="op">&lt;-</span> <span class="st">"10.5281/zenodo.17432277"</span></span>
<span></span>
<span><span class="va">pth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/zen4R/man/download_zenodo.html" class="external-link">download_zenodo</a></span><span class="op">(</span><span class="va">doi</span>, path <span class="op">=</span> <span class="va">pth</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span>, timeout <span class="op">=</span> <span class="fl">600</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">pth</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "MassBank-data-2025.10.zip"</code></pre>
</div>
</div>
<p>The archive contains several thousands of <em>.txt</em> files in MassBank format, one for each spectrum. We next unzip the archive to the same temporary folder and get the listing of all data files.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' unzip the archive</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/unzip.html" class="external-link">unzip</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pth</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">pth</span><span class="op">)</span><span class="op">[</span><span class="fl">1L</span><span class="op">]</span><span class="op">)</span>, exdir <span class="op">=</span> <span class="va">pth</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' get the file listing</span></span>
<span><span class="va">dr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">pth</span>, pattern <span class="op">=</span> <span class="st">"MassBank-MassBank"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">dr</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, pattern <span class="op">=</span> <span class="st">"txt$"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">fls</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 134674</code></pre>
</div>
</div>
<p>Each file holds one spectrum with compound, instrument, and provider metadata in MassBank format. We import the full release with <code><a href="https://rdrr.io/pkg/MsBackendMassbank/man/MsBackendMassbank.html" class="external-link">MsBackendMassbank()</a></code> into a <code>Spectra</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendMassbank" class="external-link">MsBackendMassbank</a></span><span class="op">)</span></span>
<span><span class="co">#' import the full MassBank data as a Spectra object</span></span>
<span><span class="va">s_mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendMassbank/man/MsBackendMassbank.html" class="external-link">MsBackendMassbank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">s_mb</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MSn data (Spectra) with 134440 spectra in a MsBackendMassbank backend:
         msLevel     rtime scanIndex
       &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
1              2      3.44         1
2              2      3.44         1
3              2      3.44         1
4              2      3.44         1
5              2      3.44         1
...          ...       ...       ...
134436         2     685.2         1
134437         2     685.2         1
134438         2     685.2         1
134439         2     685.2         1
134440         2     685.2         1
 ... 28 more variables/columns.</code></pre>
</div>
</div>
<p>Metadata and annotations of the compound are available as additional spectra variables, such as <code>"name"</code>, <code>"smiles"</code>, <code>"formula"</code>, <code>"inchi"</code> etc. The full list of available spectra metadata is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' available spectra variables/metadata</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">s_mb</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "msLevel"                 "rtime"
 [3] "acquisitionNum"          "scanIndex"
 [5] "dataStorage"             "dataOrigin"
 [7] "centroided"              "smoothed"
 [9] "polarity"                "precScanNum"
[11] "precursorMz"             "precursorIntensity"
[13] "precursorCharge"         "collisionEnergy"
[15] "isolationWindowLowerMz"  "isolationWindowTargetMz"
[17] "isolationWindowUpperMz"  "acquistionNum"
[19] "accession"               "name"
[21] "smiles"                  "exactmass"
[23] "formula"                 "inchi"
[25] "cas"                     "inchikey"
[27] "adduct"                  "splash"
[29] "title"                  </code></pre>
</div>
</div>
<p>The <code>metaBlocks</code> parameter can be used to enable import of extra metadata. MassBank metadata are <em>generally</em> more standardized and include more compound information (e.g., formula, exact mass). We now match the end-to-end vignette spectra against MassBank 2025.10 with <code><a href="https://rdrr.io/pkg/MetaboAnnotation/man/matchSpectra.html" class="external-link">matchSpectra()</a></code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' match the experimental spectra against the GNPS2 drug library</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/matchSpectra.html" class="external-link">matchSpectra</a></span><span class="op">(</span><span class="va">ms2_ctr_fts</span>, <span class="va">s_mb</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/CompareSpectraParam.html" class="external-link">CompareSpectraParam</a></span><span class="op">(</span>tolerance <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#' restrict data to matching spectra</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html" class="external-link">whichQuery</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetaboAnnotation/man/Matched.html" class="external-link">pruneTarget</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
</div>
<p>The experimental spectra match against spectra of compounds with the following unique InChI:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span><span class="op">$</span><span class="va">target_inchi</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "InChI=1S/C9H6O3/c10-7-5-9(11)12-8-4-2-1-3-6(7)8/h1-5,10H"
[2] "InChI=1S/C7H13N5O/c1-3-8-5-10-6(9-4-2)12-7(13)11-5/h3-4H2,1-2H3,(H3,8,9,10,11,12,13)"
[3] "InChI=1S/C8H10N4O2/c1-10-4-9-6-5(10)7(13)12(3)8(14)11(6)2/h4H,1-3H3"                 </code></pre>
</div>
</div>
<p>The names (including aliases) of the compounds are:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span><span class="op">$</span><span class="va">target_name</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "4-Hydroxycoumarin"
 [2] "4-hydroxychromen-2-one"
 [3] "Simazine-2-hydroxy"
 [4] "4,6-bis(ethylamino)-1H-1,3,5-triazin-2-one"
 [5] "2-Hydroxysimazine"
 [6] "2,6-bis(ethylamino)-1H-1,3,5-triazin-4-one"
 [7] "Caffeine"
 [8] "1,3,7-trimethyl-3,7-dihydro-1H-purine-2,6-dione"
 [9] "1,3,7-trimethylpurine-2,6-dione"
[10] "caffeine"
[11] "CAFFEINE"
[12] "1,3,7-Trimethylpurine-2,6-dione"                </code></pre>
</div>
</div>
</section></section><section class="section level2"><h2 id="creating-or-expanding-annotation-resources">Creating or expanding annotation resources<a class="anchor" aria-label="anchor" href="#creating-or-expanding-annotation-resources"></a>
</h2>
<p>Public MGF/MSP libraries can be imported into <code>Spectra</code> and exported again. Alternatively, annotations can be stored in SQL databases <em>via</em> the <code>r Biocpkg("CompoundDb")</code> package, which defines a simple database schema for small compounds and MS data. Here we build a database from the GNPS2 drug library; see the vignette <a href="https://rformassspectrometry.github.io/CompoundDb/articles/create-compounddb.html" class="external-link"><em>Creating CompoundDb annotation resources</em></a> for more examples.</p>
<div>
<blockquote>
<p><strong>Note</strong></p>
<p>The <em>CompDb</em> database layout defines 3 main database tables, one for compound annotations, one for spectra metadata and one to store the actual mass (or fragment) peaks. These tables are linked with each other through specific identifier columns (<em>primary/foreign keys</em>): each table has its own <em>ID</em> column with <strong>unique</strong> identifiers for each row. To link the MS spectra tables with the compound annotation table, the table with the MS spectra metadata contains in addition a column with the identifiers of the compound the specific fragment spectrum is associated with. An additional table <em>metadata</em> allows to define metadata information for the full annotation resource, such as a version, origin, DOI, etc.</p>
</blockquote>
</div>
<p>We first define a <code>data.frame</code> with compound annotations for the GNPS2 drug library. The MGF metadata mainly describe spectrum generation, with compound details mostly in the spectrum name and <em>INCHI</em>. Spectrum names often mix in collision energy and ion information and are not standardized:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/CompoundDb" class="external-link">CompoundDb</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' extract potential compound relevant information</span></span>
<span><span class="va">cmps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraData</a></span><span class="op">(</span><span class="va">drug_ms2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ORGANISM"</span>, <span class="st">"spectrum_name"</span>, <span class="st">"inchi"</span>,</span>
<span>                                <span class="st">"smiles"</span>, <span class="st">"exactmass"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' inspect values for the spectrum name</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">spectrum_name</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Rifamycin W M+H"   "Rifamycin W M+Na"  "Dolastatin_10 M+H"
[4] "Rifamycin S M+Na"  "Rifamycin S M+H"   "phenazine M+H"    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cmps</span><span class="op">$</span><span class="va">spectrum_name</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "TRIMEBUTINE_metabolite_031 [[M+H]+]" "TRIMEDLURE [[M+H]+]"
[3] "TRIMEDLURE [[M+Na]+]"                "TRIMEDLURE [[M+K]+]"
[5] "TRIMEDLURE [[M+H-H2O]+]"             "Bictegravir [[M+H]+]"               </code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cmps</span><span class="op">$</span><span class="va">spectrum_name</span><span class="op">[</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1006</span><span class="op">]</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ISOLEUCINE - 20.0 eV M+H" "ISOLEUCINE - 30.0 eV M+H"
[3] "ISOLEUCINE - 40.0 eV M+H" "ISOLEUCINE - 50.0 eV M+H"
[5] "ISOLEUCINE - 60.0 eV M+H" "ISOLEUCINE - 70.0 eV M+H"
[7] "GLUTAMATE - 20.0 eV M+H" </code></pre>
</div>
</div>
<p>To define the names for the compounds we first parse (and then strip) the adduct information from the spectrum name. The pattern defined below finds all sub-strings that start with a white space, followed by no, one or two <code>"["</code>, an <code>"M"</code> (or <code>"2M"</code> etc) with a <code>"+"</code> or a <code>"-"</code> followed by any character until the end of the string. This patter <em>should</em> allow to find all adduct definitions, even if they don’t follow the standard nomenclature.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sname</span> <span class="op">&lt;-</span> <span class="va">cmps</span><span class="op">$</span><span class="va">spectrum_name</span></span>
<span></span>
<span><span class="co">#' define the pattern for adduct definitions</span></span>
<span><span class="va">paddct</span> <span class="op">&lt;-</span> <span class="st">"\\s(\\[{0,2}\\d?M)(\\]|\\+|-|$).*$"</span></span>
<span></span>
<span><span class="co">#' extract the adduct definition from the spectrum names</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="va">addct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="va">sname</span>, <span class="va">paddct</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html" class="external-link">str_trim</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">addct</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "M+H"     "M+Na"    "M+2H"    NA        "M-H"     "M+H-H20"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">addct</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "M+C"          "[[M+H]+]"     "[[M+K]+]"     "[[M+H-H2O]+]" "[[M+Na]+]"
[6] "[[M]+]"      </code></pre>
</div>
</div>
<p>Ideally we would standardize adducts (e.g., convert <code>"M+H"</code> or <code>"[[M+H]+]"</code> to <code>"[M+H]+"</code>), but here we keep the provided values and store them as a new <code>adduct</code> variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' create a new spectra variable with adduct information</span></span>
<span><span class="va">drug_ms2</span><span class="op">$</span><span class="va">adduct</span> <span class="op">&lt;-</span> <span class="va">addct</span></span></code></pre></div>
</div>
<p>We strip adducts from the spectrum names, drop trailing <code>" Unknown"</code>, and remove extra quotes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' remove any adduct definitions from the compound name</span></span>
<span><span class="va">cname</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="va">paddct</span>, <span class="st">""</span>, <span class="va">sname</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"\\sUnknown$"</span>, replacement <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"\""</span>, replacement <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span></code></pre></div>
</div>
<p>For some spectra also the collision energy was included in the name. Some examples are:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cname</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">844</span>, <span class="fl">845</span>, <span class="fl">8845</span>, <span class="fl">8846</span>, <span class="fl">69316</span>, <span class="fl">9762</span>, <span class="fl">9763</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "TYRAMINE - 20.0 eV"                "TYRAMINE - 30.0 eV"
[3] "Benzylpenicillin_40eV"             "Benzylpenicillin_50eV"
[5] "Daidzein - 50eV"                   "tryptophan CollisionEnergy:205060"
[7] "tryptophan CollisionEnergy:102040"</code></pre>
</div>
</div>
<p>We define a pattern to capture these collision energy definitions and strip it from the compound names.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pce1</span> <span class="op">&lt;-</span> <span class="st">"(_|\\s-\\s|\\s)(\\d*.*)eV$"</span></span>
<span><span class="va">pce2</span> <span class="op">&lt;-</span> <span class="st">" CollisionEnergy:\\d+$"</span></span>
<span><span class="va">cname</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="va">pce1</span>, replacement <span class="op">=</span> <span class="st">""</span>, <span class="va">cname</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="va">pce2</span>, replacement <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Some spectrum names also include the original database ID:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cname</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">36925</span>, <span class="fl">56836</span>, <span class="fl">57333</span>, <span class="fl">68442</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Massbank:BML00001 Cytisine"
[2] "MassbankEU:ET010001 CLC_301.1468_14.3|Chlorcyclizine|1-[(4-chlorophenyl)-phenylmethyl]-4-methylpiperazine"
[3] "MoNA:2504 Ceftiofur"
[4] "HMDB:HMDB00145-218 Estrone"                                                                               </code></pre>
</div>
</div>
<p>Ideally we would split these IDs into separate columns; here we keep them in the compound name, rename <em>ORGANISM</em> to <em>data_origin</em>, and ensure <em>exactmass</em> is numeric.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' add compound names to the data.frame</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">name</span> <span class="op">&lt;-</span> <span class="va">cname</span></span>
<span><span class="co">#' remove unneded columns</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">spectrum_name</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="co">#' rename "ORGANISM" column name to "data_origin"</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cmps</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"ORGANISM"</span>, <span class="st">"data_origin"</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cmps</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#' ensure column exactmass is of type numeric</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">exactmass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cmps</span><span class="op">$</span><span class="va">exactmass</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We clean <em>smiles</em> and <em>inchi</em> by trimming whitespace, removing <code>"N/A"</code>, and dropping extra quotes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' excess "</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">inchi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\""</span>, <span class="st">""</span>, <span class="va">cmps</span><span class="op">$</span><span class="va">inchi</span><span class="op">)</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">smiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\""</span>, <span class="st">""</span>, <span class="va">cmps</span><span class="op">$</span><span class="va">smiles</span><span class="op">)</span></span>
<span><span class="co">#' white spaces</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">inchi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html" class="external-link">str_trim</a></span><span class="op">(</span><span class="va">cmps</span><span class="op">$</span><span class="va">inchi</span><span class="op">)</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">smiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html" class="external-link">str_trim</a></span><span class="op">(</span><span class="va">cmps</span><span class="op">$</span><span class="va">smiles</span><span class="op">)</span></span>
<span><span class="co">#' NA encodings</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">inchi</span><span class="op">[</span><span class="va">cmps</span><span class="op">$</span><span class="va">inchi</span> <span class="op">==</span> <span class="st">""</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA_character_</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">inchi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"^N/A"</span>, <span class="cn">NA_character_</span>, <span class="va">cmps</span><span class="op">$</span><span class="va">inchi</span><span class="op">)</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">smiles</span><span class="op">[</span><span class="va">cmps</span><span class="op">$</span><span class="va">smiles</span> <span class="op">==</span> <span class="st">""</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA_character_</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">smiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"^N/A"</span>, <span class="cn">NA_character_</span>, <span class="va">cmps</span><span class="op">$</span><span class="va">smiles</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Finally, we add remaining required columns <code>"inchikey"</code>, <code>"formula"</code> and <code>"synonyms"</code>. No related information was provided in the input MGF and we thus fill these with <code>NA</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' add missing columns and initialize with NA</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">inchikey</span> <span class="op">&lt;-</span> <span class="cn">NA_character_</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">formula</span> <span class="op">&lt;-</span> <span class="cn">NA_character_</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">synonyms</span> <span class="op">&lt;-</span> <span class="cn">NA_character_</span></span></code></pre></div>
</div>
<p>Next we define spectra metadata. Suggested columns include <code>polarity</code> (<code>0/1/NA</code>), <code>collision_energy</code>, <code>instrument</code>, <code>instrument_type</code>, and <code>precursor_mz</code> with <em>CompoundDb</em> accepting also optional additional columns. We extract these from the GNPS2 <code>Spectra</code> object into a <code>data.frame</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' extract the spectra information and data</span></span>
<span><span class="va">spctra</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraData</a></span><span class="op">(</span><span class="va">drug_ms2</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"spectrum_name"</span>,</span>
<span>                        <span class="st">"polarity"</span>,</span>
<span>                        <span class="st">"collisionEnergy"</span>,</span>
<span>                        <span class="st">"FILENAME"</span>,</span>
<span>                        <span class="st">"PI"</span>,</span>
<span>                        <span class="st">"DATACOLLECTOR"</span>,</span>
<span>                        <span class="st">"PUBMED"</span>,</span>
<span>                        <span class="st">"LIBRARYQUALITY"</span>,</span>
<span>                        <span class="st">"SPECTRUMID"</span>,</span>
<span>                        <span class="st">"SOURCE_INSTRUMENT"</span>,</span>
<span>                        <span class="st">"precursorMz"</span>,</span>
<span>                        <span class="st">"mz"</span>,</span>
<span>                        <span class="st">"intensity"</span><span class="op">)</span></span>
<span>                      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We rename <em>SOURCE_INSTRUMENT</em> to <code>instrument_type</code>, add an empty <code>instrument</code> column, and replace <code>"N/A"</code> with <code>NA</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' add instrument information</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spctra</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"SOURCE_INSTRUMENT"</span>, <span class="st">"instrument_type"</span>,</span>
<span>                        <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spctra</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">spctra</span><span class="op">$</span><span class="va">instrument</span> <span class="op">&lt;-</span> <span class="cn">NA_character_</span></span>
<span><span class="co">#' fix missing values</span></span>
<span><span class="va">spctra</span><span class="op">$</span><span class="va">PI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"^N/A"</span>, <span class="cn">NA_character_</span>, <span class="va">spctra</span><span class="op">$</span><span class="va">PI</span><span class="op">)</span></span>
<span><span class="va">spctra</span><span class="op">$</span><span class="va">DATACOLLECTOR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"^N/A"</span>, <span class="cn">NA_character_</span>, <span class="va">spctra</span><span class="op">$</span><span class="va">DATACOLLECTOR</span><span class="op">)</span></span>
<span><span class="va">spctra</span><span class="op">$</span><span class="va">PUBMED</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"^N/A"</span>, <span class="cn">NA_character_</span>, <span class="va">spctra</span><span class="op">$</span><span class="va">PUBMED</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We standardize column names to match <em>Spectra</em>/<em>CompoundDb</em> conventions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' reformat column names</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spctra</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"collisionEnergy"</span>, <span class="st">"collision_energy"</span>,</span>
<span>                        <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spctra</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spctra</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"precursorMz"</span>, <span class="st">"precursor_mz"</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spctra</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spctra</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"SPECTRUMID"</span>, <span class="st">"original_spectrum_id"</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spctra</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spctra</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spctra</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<p>To allow linking spectra to compounds (i.e., rows in the <code>cmps</code> with rows in the <code>spctra</code> data frames) we add unique IDs for each table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' add compound and spectra IDs to the respective tables</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cmps</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cmps</span><span class="op">$</span><span class="va">compound_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"CMP%0"</span>, <span class="va">n</span>, <span class="st">"d"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cmps</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">spctra</span><span class="op">$</span><span class="va">spectrum_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cmps</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Ideally compounds would be unique and spectra could map many-to-one. Here each compound row corresponds to one spectrum, so we add <code>compound_id</code> directly to <code>spctra</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' define the relationship between spectra and compounds</span></span>
<span><span class="va">spctra</span><span class="op">$</span><span class="va">compound_id</span> <span class="op">&lt;-</span> <span class="va">cmps</span><span class="op">$</span><span class="va">compound_id</span></span></code></pre></div>
</div>
<p>Finally we define database metadata (origin, version, DOI) for reproducibility.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' define metadata for the annotation resource</span></span>
<span><span class="va">metad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CompoundDb/man/createCompDb.html" class="external-link">make_metadata</a></span><span class="op">(</span>source <span class="op">=</span> <span class="st">"GNPS"</span>,</span>
<span>                       url <span class="op">=</span> <span class="st">"https://doi.org/10.5281/zenodo.17232042"</span>,</span>
<span>                       source_version <span class="op">=</span> <span class="st">"v4"</span>,</span>
<span>                       source_date <span class="op">=</span> <span class="st">"2025-09-30"</span>,</span>
<span>                       organism <span class="op">=</span> <span class="cn">NA_character_</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Now, with all tables and relevant information available, we can create the SQLite-based annotation resource using the <code><a href="https://rdrr.io/pkg/CompoundDb/man/createCompDb.html" class="external-link">createCompDb()</a></code> function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' create an annotation database in CompDb format</span></span>
<span><span class="va">db_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CompoundDb/man/createCompDb.html" class="external-link">createCompDb</a></span><span class="op">(</span><span class="va">cmps</span>,</span>
<span>                        metadata <span class="op">=</span> <span class="va">metad</span>,</span>
<span>                        msms_spectra <span class="op">=</span> <span class="va">spctra</span>,</span>
<span>                        dbFile <span class="op">=</span> <span class="st">"GNPS-drug-library.v4.sqlite"</span><span class="op">)</span></span></code></pre></div>
</div>
<p>All tables are stored in the SQLite file <em>./GNPS-drug-library.v4.sqlite</em>, usable with any SQLite client. Below we connect with <em>RSQLite</em> and list tables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rsqlite.r-dbi.org" class="external-link">RSQLite</a></span><span class="op">)</span></span>
<span><span class="co">#' connect to the database</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">db_file</span><span class="op">)</span></span>
<span><span class="co">#' list the available tables</span></span>
<span><span class="fu">dbListTables</span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "metadata"           "ms_compound"        "msms_spectrum"
[4] "msms_spectrum_peak" "synonym"           </code></pre>
</div>
</div>
<p>We could also use SQL queries to retrieve data from this database. For example we extract below the first 10 entries of the database table with the mass peak data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' get first 10 rows of the peak data table</span></span>
<span><span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">con</span>, <span class="st">"select * from msms_spectrum_peak limit 10"</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   spectrum_id       mz   intensity peak_id
1            1 55.01783 0.001102225       1
2            1 55.05472 0.010090073       2
3            1 57.03398 0.006352579       3
4            1 57.06980 0.001213007       4
5            1 65.03873 0.001344491       5
6            1 67.05451 0.018575616       6
7            1 68.05765 0.001046733       7
8            1 69.03366 0.008645037       8
9            1 69.06998 0.009978069       9
10           1 77.03866 0.005749947      10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' disconnect from the database</span></span>
<span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code></pre></div>
</div>
<p>For direct use, we load the database as a <code>CompDb</code> annotation resource:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CompoundDb/man/CompDb.html" class="external-link">CompDb</a></span><span class="op">(</span><span class="va">db_file</span><span class="op">)</span></span>
<span><span class="va">cdb</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class: CompDb
 data source: GNPS
 version: v4
 organism: NA
 compound count: 105856
 MS/MS spectra count: 105856 </code></pre>
</div>
</div>
<p>This simplifies access via <em><a href="https://bioconductor.org/packages/3.22/CompoundDb" class="external-link">CompoundDb</a></em> functions such as <code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compounds()</a></code>, <code><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter()</a></code>, and <code><a href="https://rdrr.io/pkg/S4Vectors/man/Annotated-class.html" class="external-link">metadata()</a></code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' get the resource's metadata</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Annotated-class.html" class="external-link">metadata</a></span><span class="op">(</span><span class="va">cdb</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                name                                   value
1             source                                    GNPS
2                url https://doi.org/10.5281/zenodo.17232042
3     source_version                                      v4
4        source_date                              2025-09-30
5           organism                                    &lt;NA&gt;
6   db_creation_date                Tue Feb  3 17:42:13 2026
7 supporting_package                              CompoundDb
8  supporting_object                                  CompDb</code></pre>
</div>
</div>
<p>For MS2 workflows, interface with the <code>CompDb</code> via a <code>Spectra</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' access the annotation resource as a `Spectra` object</span></span>
<span><span class="va">sps_cdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">cdb</span><span class="op">)</span></span>
<span><span class="va">sps_cdb</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MSn data (Spectra) with 105856 spectra in a MsBackendCompDb backend:
         msLevel precursorMz  polarity
       &lt;integer&gt;   &lt;numeric&gt; &lt;integer&gt;
1             NA     656.306         1
2             NA     678.290         1
3             NA     785.230         1
4             NA     718.286         1
5             NA     696.304         1
...          ...         ...       ...
105852        NA     233.131         1
105853        NA     255.113         1
105854        NA     271.087         1
105855        NA     215.120         1
105856        NA     450.127         1
 ... 39 more variables/columns.
 Use  'spectraVariables' to list all of them.
 data source: GNPS
 version: v4
 organism: NA </code></pre>
</div>
</div>
<p>This <code>Spectra</code> object can then be used for annotation workflows as described in the previous section or the <em>MS2-based annotation</em> section of the main <a href="https://rformassspectrometry.github.io/Metabonaut/articles/a-end-to-end-untargeted-metabolomics.html"><em>Complete end-to-end LC-MS/MS Metabolomic Data analysis</em></a> workflow.</p>
</section><section class="section level2"><h2 id="properties-of-compdb-mgf-and-msp-format-based-annotation-resources">Properties of <code>CompDb</code>, MGF and MSP-format based annotation resources<a class="anchor" aria-label="anchor" href="#properties-of-compdb-mgf-and-msp-format-based-annotation-resources"></a>
</h2>
<p>The <em><a href="https://bioconductor.org/packages/3.22/Spectra" class="external-link">Spectra</a></em> ecosystem loads MS data from many formats, enabling integration of diverse libraries into R workflows.</p>
<p>MGF and MSP are common exchange formats but repeat compound annotations for every spectrum. Loading them requires reading all data, which can be slow and memory-heavy for large libraries.</p>
<p>For example, the memory usage for the GNPS drug library imported from the MGF file is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">drug_ms2</span><span class="op">)</span>, unit <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>259.9 Mb</code></pre>
</div>
</div>
<p>This file is manageable; the full GNPS library might exceed the available memory of a standard computer.</p>
<p>In contrast, the memory size for the <code>Spectra</code> object of the <em>CompDb</em> annotation database created from the GNPS2 drug library is only:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps_cdb</span><span class="op">)</span>, unit <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>14.5 Mb</code></pre>
</div>
</div>
<p>The <code>sps_cdb</code> <code>Spectra</code> object keeps only spectrum IDs in memory and fetches other data on demand, keeping memory low.</p>
<p>Another advantage of <em>CompDb</em> resources over MGF/MSP-based file formats is the possibility to assign <em>metadata</em> to the resource:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Annotated-class.html" class="external-link">metadata</a></span><span class="op">(</span><span class="va">cdb</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                name                                   value
1             source                                    GNPS
2                url https://doi.org/10.5281/zenodo.17232042
3     source_version                                      v4
4        source_date                              2025-09-30
5           organism                                    &lt;NA&gt;
6   db_creation_date                Tue Feb  3 17:42:13 2026
7 supporting_package                              CompoundDb
8  supporting_object                                  CompDb</code></pre>
</div>
</div>
<p>However, creating a <em>CompDb</em> requires an upfront cleanup and conversion to store data in SQLite. Once built, the resource is self-contained and shareable.</p>
<p>The <em>CompDb</em> format also supports adding new compounds or spectra, enabling extension of in-house libraries (see the <em>CompoundDb</em> vignette mentioned above).</p>
<p>Currently the format is only supported directly in R, though any SQLite client can read the database.</p>
</section><section class="section level2"><h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>Importing public reference libraries is straightforward. The challenge is harmonizing metadata and annotations across sources. Interpretation benefits from cleaned, standardized information. Efforts such as <span class="citation" data-cites="de_jonge_reproducible_2024">(<a href="#ref-de_jonge_reproducible_2024" role="doc-biblioref">Jonge et al. 2024</a>)</span> help, but broader standardization of data and naming conventions is still needed.</p>
</section><section class="section level2"><h2 id="outlook">Outlook<a class="anchor" aria-label="anchor" href="#outlook"></a>
</h2>
<ul>
<li>Support for the newly defined <em>mzSpecLib</em> file format will be added to the <em>RforMassSpectrometry</em> package ecosystem.</li>
<li>Access to public libraries will be simplified, e.g. by making them available through <em>AnnotationHub</em>.</li>
</ul></section><section class="section level2"><h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.2 (2025-10-31)
Platform: x86_64-pc-linux-gnu
Running under: Ubuntu 24.04.3 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3
LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C
 [9] LC_ADDRESS=C               LC_TELEPHONE=C
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C

time zone: Etc/UTC
tzcode source: system (glibc)

attached base packages:
[1] stats4    stats     graphics  grDevices utils     datasets  methods
[8] base

other attached packages:
 [1] RSQLite_2.4.5            stringr_1.6.0            MsBackendMassbank_1.18.2
 [4] CompoundDb_1.14.2        AnnotationFilter_1.34.0  AnnotationHub_4.0.0
 [7] BiocFileCache_3.0.0      dbplyr_2.5.1             SpectriPy_1.0.0
[10] reticulate_1.44.1        MetaboAnnotation_1.14.0  MsBackendMgf_1.18.0
[13] zen4R_0.10.4             Spectra_1.20.1           BiocParallel_1.44.0
[16] S4Vectors_0.48.0         BiocGenerics_0.56.0      generics_0.1.4
[19] BiocStyle_2.38.0         quarto_1.5.1.9002        knitr_1.51

loaded via a namespace (and not attached):
  [1] DBI_1.2.3                   bitops_1.0-9
  [3] httr2_1.2.2                 gridExtra_2.3
  [5] rlang_1.1.7                 magrittr_2.0.4
  [7] clue_0.3-66                 otel_0.2.0
  [9] matrixStats_1.5.0           compiler_4.5.2
 [11] png_0.1-8                   vctrs_0.7.1
 [13] reshape2_1.4.5              ProtGenerics_1.42.0
 [15] crayon_1.5.3                pkgconfig_2.0.3
 [17] MetaboCoreUtils_1.18.1      fastmap_1.2.0
 [19] XVector_0.50.0              utf8_1.2.6
 [21] rmarkdown_2.30              ps_1.9.1
 [23] purrr_1.2.1                 bit_4.6.0
 [25] xfun_0.56                   MultiAssayExperiment_1.36.1
 [27] cachem_1.1.0                ChemmineR_3.62.0
 [29] jsonlite_2.0.0              blob_1.3.0
 [31] later_1.4.5                 DelayedArray_0.36.0
 [33] parallel_4.5.2              cluster_2.1.8.1
 [35] R6_2.6.1                    stringi_1.8.7
 [37] RColorBrewer_1.1-3          GenomicRanges_1.62.1
 [39] Rcpp_1.1.1                  Seqinfo_1.0.0
 [41] SummarizedExperiment_1.40.0 base64enc_0.1-6
 [43] IRanges_2.44.0              BiocBaseUtils_1.12.0
 [45] Matrix_1.7-4                igraph_2.2.1
 [47] tidyselect_1.2.1            rstudioapi_0.18.0
 [49] abind_1.4-8                 yaml_2.3.12
 [51] codetools_0.2-20            curl_7.0.0
 [53] processx_3.8.6              lattice_0.22-7
 [55] tibble_3.3.1                plyr_1.8.9
 [57] withr_3.0.2                 KEGGREST_1.50.0
 [59] Biobase_2.70.0              S7_0.2.1
 [61] evaluate_1.0.5              xml2_1.5.2
 [63] Biostrings_2.78.0           filelock_1.0.3
 [65] pillar_1.11.1               BiocManager_1.30.27
 [67] MatrixGenerics_1.22.0       DT_0.34.0
 [69] rprojroot_2.1.1             RCurl_1.98-1.17
 [71] BiocVersion_3.22.0          ggplot2_4.0.1
 [73] scales_1.4.0                glue_1.8.0
 [75] lazyeval_0.2.2              tools_4.5.2
 [77] data.table_1.18.2.1         QFeatures_1.20.0
 [79] fs_1.6.6                    XML_3.99-0.20
 [81] grid_4.5.2                  tidyr_1.3.2
 [83] AnnotationDbi_1.72.0        MsCoreUtils_1.22.1
 [85] cli_3.6.5                   rappdirs_0.3.4
 [87] rsvg_2.7.0                  S4Arrays_1.10.1
 [89] keyring_1.4.1.9000          dplyr_1.1.4
 [91] gtable_0.3.6                digest_0.6.39
 [93] SparseArray_1.10.8          rjson_0.2.23
 [95] htmlwidgets_1.6.4           farver_2.1.2
 [97] memoise_2.0.1               htmltools_0.5.9
 [99] lifecycle_1.0.5             here_1.0.2
[101] httr_1.4.7                  bit64_4.6.0-1
[103] MASS_7.3-65                </code></pre>
</div>
</div>
</section><section class="section level2"><h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-graeve_spectripy_2025" class="csl-entry" role="listitem">
Graeve, Marilyn De, Wout Bittremieux, Thomas Naake, Carolin Huber, Matthias Anagho-Mattanovich, Nils Hoffmann, Pierre Marchal, et al. 2025. <span>“<span>SpectriPy</span>: <span>Enhancing</span> <span>Cross</span>-<span>Language</span> <span>Mass</span> <span>Spectrometry</span> <span>Data</span> <span>Analysis</span> with <span>R</span> and <span>Python</span>.”</span> <em>Journal of Open Source Software</em> 10 (109): 8070. <a href="https://doi.org/10.21105/joss.08070" class="external-link">https://doi.org/10.21105/joss.08070</a>.
</div>
<div id="ref-huber_matchms_2020" class="csl-entry" role="listitem">
Huber, Florian, Stefan Verhoeven, Christiaan Meijer, Hanno Spreeuw, Efraín Manuel Villanueva Castilla, Cunliang Geng, Justin J. j van der Hooft, et al. 2020. <span>“Matchms - Processing and Similarity Evaluation of Mass Spectrometry Data.”</span> <em>Journal of Open Source Software</em> 5 (52): 2411. <a href="https://doi.org/10.21105/joss.02411" class="external-link">https://doi.org/10.21105/joss.02411</a>.
</div>
<div id="ref-de_jonge_reproducible_2024" class="csl-entry" role="listitem">
Jonge, Niek F. de, Helge Hecht, Michael Strobel, Mingxun Wang, Justin J. J. van der Hooft, and Florian Huber. 2024. <span>“Reproducible <span>MS</span>/<span>MS</span> Library Cleaning Pipeline in Matchms.”</span> <em>Journal of Cheminformatics</em> 16 (1): 88. <a href="https://doi.org/10.1186/s13321-024-00878-1" class="external-link">https://doi.org/10.1186/s13321-024-00878-1</a>.
</div>
<div id="ref-neumann_massbank_2025" class="csl-entry" role="listitem">
Neumann, Steffen, René Meier, Michael Wenk, Anjana Elapavalore, Takaaki Nishioka, Tobias Schulze, Michael Stravs, Hiroshi Tsugawa, Fumio Matsuda, and Emma L. Schymanski. 2025. <span>“<span>MassBank</span>: An Open and <span>FAIR</span> Mass Spectral Data Resource.”</span> <em>Nucleic Acids Research</em>, November, gkaf1193. <a href="https://doi.org/10.1093/nar/gkaf1193" class="external-link">https://doi.org/10.1093/nar/gkaf1193</a>.
</div>
<div id="ref-wang_sharing_2016" class="csl-entry" role="listitem">
Wang, Mingxun, Jeremy J. Carver, Vanessa V. Phelan, Laura M. Sanchez, Neha Garg, Yao Peng, Don Duy Nguyen, et al. 2016. <span>“Sharing and Community Curation of Mass Spectrometry Data with <span>Global</span> <span>Natural</span> <span>Products</span> <span>Social</span> <span>Molecular</span> <span>Networking</span>.”</span> <em>Nature Biotechnology</em> 34 (8): 828–37. <a href="https://doi.org/10.1038/nbt.3597" class="external-link">https://doi.org/10.1038/nbt.3597</a>.
</div>
<div id="ref-wishart_hmdb_2021" class="csl-entry" role="listitem">
Wishart, David S, AnChi Guo, Eponine Oler, Fei Wang, Afia Anjum, Harrison Peters, Raynard Dizon, et al. 2021. <span>“<span>HMDB</span> 5.0: The <span>Human</span> <span>Metabolome</span> <span>Database</span> for 2022.”</span> <em>Nucleic Acids Research</em> 50 (D1): D622–31. <a href="https://doi.org/10.1093/nar/gkab1062" class="external-link">https://doi.org/10.1093/nar/gkab1062</a>.
</div>
<div id="ref-zhao_resource_2025" class="csl-entry" role="listitem">
Zhao, Haoqi Nina, Kine Eide Kvitne, Corinna Brungs, Siddharth Mohan, Vincent Charron-Lamoureux, Wout Bittremieux, Runbang Tang, et al. 2025. <span>“A Resource to Empirically Establish Drug Exposure Records Directly from Untargeted Metabolomics Data.”</span> <em>Nature Communications</em> 16 (1): 10600. <a href="https://doi.org/10.1038/s41467-025-65993-5" class="external-link">https://doi.org/10.1038/s41467-025-65993-5</a>.
</div>
</div>
</section><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philippine Louail, Marilyn De Graeve, Vilhelm Suksi, Johannes Rainer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
